<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= storyUser.username %> ‚Ä¢ Story</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- üåô USE GLOBAL THEME VARIABLES -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont,
                         "Segoe UI", Roboto, Helvetica, Arial;
        }

        body {
            background: var(--bg);
            color: var(--text);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .story-container {
            width: 100%;
            max-width: 450px;
            height: 95vh;
            border-radius: 18px;
            overflow: hidden;
            position: relative;
            background: var(--card);
            box-shadow: 0 0 25px rgba(0,0,0,0.6);
        }

        /* ================= PROGRESS ================= */

        .progress-container {
            position: absolute;
            top: 10px;
            left: 0;
            width: 100%;
            padding: 0 10px;
            display: flex;
            gap: 4px;
            z-index: 20;
        }

        .progress-segment {
            flex: 1;
            height: 3px;
            background: rgba(255,255,255,0.35);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            width: 0%;
            height: 100%;
            background: #fff;
        }

        /* ================= HEADER ================= */

        .story-header {
            position: absolute;
            top: 25px;
            left: 0;
            width: 100%;
            padding: 15px;
            display: flex;
            gap: 10px;
            background: linear-gradient(
                to bottom,
                rgba(0,0,0,0.6),
                transparent
            );
            z-index: 20;
        }

        .avatar img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid #fff;
            object-fit: cover;
        }

        .username {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
        }

        .story-counter,
        .story-views {
            font-size: 12px;
            color: #fff;
            opacity: 0.8;
        }

        /* ================= NAV ================= */

        .nav-area {
            position: absolute;
            top: 0;
            height: 100%;
            width: 30%;
            z-index: 10;
            cursor: pointer;
        }

        .nav-prev { left: 0; }
        .nav-next { right: 0; }

        /* ================= CLOSE ================= */

        .close-btn {
            position: absolute;
            top: 20px;
            right: 15px;
            background: rgba(0,0,0,0.6);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: none;
            color: white;
            cursor: pointer;
            z-index: 25;
        }

        /* ================= CONTENT ================= */

        .story-content,
        .story-content img,
        .story-content video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* ================= REACTIONS ================= */

        .story-reactions {
            position: absolute;
            bottom: 80px;
            left: 20px;
            display: flex;
            gap: 10px;
            z-index: 25;
            align-items: center;
        }

        .reaction-btn {
            background: rgba(0,0,0,0.45);
            border: none;
            color: white;
            font-size: 20px;
            padding: 8px;
            border-radius: 50%;
            cursor: pointer;
        }

        .reaction-btn:hover {
            transform: scale(1.15);
        }

        .reaction-summary a {
            color: white;
            font-size: 13px;
            text-decoration: none;
        }

        .reaction-summary a:hover {
            text-decoration: underline;
        }

        /* ================= FOOTER ================= */

        .story-footer {
            position: absolute;
            bottom: 0;
            width: 100%;
            padding: 20px;
            background: linear-gradient(
                to top,
                rgba(0,0,0,0.8),
                transparent
            );
        }

        .reply-box {
            display: flex;
            gap: 10px;
        }

        .reply-input {
            flex: 1;
            padding: 10px 15px;
            border-radius: 25px;
            border: none;
            background: rgba(255,255,255,0.2);
            color: #fff;
        }

        .action-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.2);
            color: white;
            cursor: pointer;
        }

        .send-btn { background: #4a4af0; }

        /* ================= TOAST ================= */

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.85);
            color: #fff;
            padding: 10px 18px;
            border-radius: 999px;
            font-size: 13px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .toast.show { opacity: 1; }
    </style>
</head>

<body>
<div class="story-container">

    <!-- Progress bars -->
    <div class="progress-container" id="progressContainer">
        <% if (stories && stories.length > 0) { %>
            <% stories.forEach(function(story, index) { %>
                <div class="progress-segment">
                    <div class="progress-fill" id="progress-<%= index %>"></div>
                </div>
            <% }); %>
        <% } %>
    </div>

    <!-- Navigation click zones -->
    <div class="nav-area nav-prev" onclick="previousStory()"></div>
    <div class="nav-area nav-next" onclick="nextStory()"></div>

    <!-- Header -->
    <div class="story-header">
        <div class="avatar">
            <img src="/uploads/<%= storyUser.avatar %>" alt="avatar">
        </div>
        <div>
            <div class="username"><%= storyUser.username %></div>
            <div class="story-counter">
                <%= currentStoryIndex + 1 %>/<%= stories.length %>
            </div>

          <% if (session.user && session.user.id === storyUser.id) { %>

    <!-- ‚úÖ STORY VIEWS -->
    <a href="/stories/<%= stories[currentStoryIndex].id %>/views"
       class="story-views">
        üëÅ Seen by <%= stories[currentStoryIndex].viewCount || 0 %>
    </a>

    <br>

    <!-- ‚úÖ STORY REACTIONS -->
    <a href="/story/<%= stories[currentStoryIndex].id %>/reactions"
       class="story-views">
        ‚ù§Ô∏è Reactions (<%= stories[currentStoryIndex].reactionCount || 0 %>)
    </a>

<% } %>
        </div>
    </div>

    <!-- Close -->
    <button class="close-btn" onclick="closeStory()">
        <i class="fas fa-times"></i>
    </button>

    <!-- Story content -->
    <div class="story-content" id="storyContent">
        <% const currentStory = stories[currentStoryIndex]; %>
        <% if (currentStory.media_type === 'image') { %>
            <img src="/uploads/<%= currentStory.media %>">
        <% } else { %>
            <video src="/uploads/<%= currentStory.media %>" autoplay playsinline muted></video>
        <% } %>
    </div>

   <!-- ‚úÖ STORY REACTIONS (UPDATED & CLICKABLE FOR OWNER) -->
<div class="story-reactions">

    <!-- Reaction buttons (for everyone) -->
    <% ["‚ù§Ô∏è","üî•","üòÇ"].forEach(r => { %>
        <button
            class="reaction-btn"
            onclick="sendReaction('<%= stories[currentStoryIndex].id %>', '<%= r %>')">
            <%= r %>
        </button>
    <% }) %>

    <!-- ‚úÖ Reaction summary (ONLY owner can click) -->
    <% if (session.user.id === storyUser.id) { %>
        <div class="reaction-summary">
            <a href="/story/<%= stories[currentStoryIndex].id %>/reactions">
                Seen by <%= stories[currentStoryIndex].viewCount || 0 %>
            </a>
        </div>
    <% } %>

</div>


    <!-- Footer -->
    <div class="story-footer">
        <div class="reply-box">
            <input
                type="text"
                class="reply-input"
                placeholder="Send message..."
                id="replyInput"
                autocomplete="off"
            >
            <div class="action-buttons">
                <button class="action-btn like-btn" id="likeBtn">
                    <i class="fa-regular fa-heart" id="likeIcon"></i>
                </button>
                <button class="action-btn send-btn" id="sendBtn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast -->
<div id="toast" class="toast">Message sent</div>

<script>
    const stories = <%- JSON.stringify(stories || []) %>;
    let currentStoryIndex = <%= currentStoryIndex || 0 %>;
    const storyUser = <%- JSON.stringify(storyUser || {}) %>;

    const DURATION = 5000;
    let isPaused = false;
    let storyTimeout = null;

    function sendReaction(storyId, reaction) {
        fetch(`/story/${storyId}/react`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ reaction })
        });
    }

    /* ‚úÖ REST OF YOUR EXISTING JS ‚Äî UNCHANGED */



    // Initialize progress bars
    function initializeProgress() {
        if (!stories || stories.length === 0) return;

        // Reset all bars
        for (let i = 0; i < stories.length; i++) {
            const bar = document.getElementById('progress-' + i);
            if (bar) {
                bar.style.transition = 'none';
                bar.style.width = '0%';
            }
        }

        // Completed bars
        for (let i = 0; i < currentStoryIndex; i++) {
            const bar = document.getElementById('progress-' + i);
            if (bar) {
                bar.style.transition = 'none';
                bar.style.width = '100%';
            }
        }

        // Start current one
        startCurrentStory();
    }

    function startCurrentStory() {
        if (currentStoryIndex >= stories.length) {
            closeStory();
            return;
        }

        const bar = document.getElementById('progress-' + currentStoryIndex);
        if (!bar) return;

        // Reset transition and width
        bar.style.transition = 'none';
        bar.style.width = '0%';

        // Force reflow
        void bar.offsetWidth;

        // Animate
        bar.style.transition = 'width ' + DURATION + 'ms linear';
        bar.style.width = '100%';

        clearTimeout(storyTimeout);
        storyTimeout = setTimeout(function() {
            if (!isPaused) {
                nextStory();
            }
        }, DURATION);
    }

    function pauseStory() {
        if (isPaused || stories.length === 0) return;
        isPaused = true;
        clearTimeout(storyTimeout);

        const bar = document.getElementById('progress-' + currentStoryIndex);
        if (!bar) return;

        const computedStyle = window.getComputedStyle(bar);
        const currentWidth = parseFloat(computedStyle.width);
        const parentWidth = bar.parentElement.offsetWidth || 1;
        const progress = currentWidth / parentWidth;

        bar.dataset.progress = progress; // store
        bar.style.transition = 'none';
        bar.style.width = (progress * 100) + '%';
    }

    function resumeStory() {
        if (!isPaused || stories.length === 0) return;
        isPaused = false;

        const bar = document.getElementById('progress-' + currentStoryIndex);
        if (!bar) return;

        const progress = parseFloat(bar.dataset.progress || '0');
        const remainingTime = DURATION * (1 - progress);

        bar.style.transition = 'none';
        bar.style.width = (progress * 100) + '%';
        void bar.offsetWidth; // reflow

        bar.style.transition = 'width ' + remainingTime + 'ms linear';
        bar.style.width = '100%';

        clearTimeout(storyTimeout);
        storyTimeout = setTimeout(function() {
            if (!isPaused) {
                nextStory();
            }
        }, remainingTime);
    }

    function nextStory() {
        clearTimeout(storyTimeout);
        if (currentStoryIndex < stories.length - 1) {
            currentStoryIndex++;
            window.location.href = '/story/' + storyUser.id + '/' + currentStoryIndex;
        } else {
            closeStory();
        }
    }

    function previousStory() {
        clearTimeout(storyTimeout);
        if (currentStoryIndex > 0) {
            currentStoryIndex--;
            window.location.href = '/story/' + storyUser.id + '/' + currentStoryIndex;
        }
    }

    function closeStory() {
        clearTimeout(storyTimeout);
        window.location.href = '/posts';
    }

    // Toast helper for message feature
    function showToast(text) {
        const toast = document.getElementById('toast');
        toast.textContent = text;
        toast.classList.add('show');
        setTimeout(function() {
            toast.classList.remove('show');
        }, 2000);
    }

    document.addEventListener('DOMContentLoaded', function() {
        if (stories.length > 0) {
            initializeProgress();
        }

        const contentEl = document.getElementById('storyContent');
        const inputEl = document.getElementById('replyInput');
        const likeBtn = document.getElementById('likeBtn');
        const likeIcon = document.getElementById('likeIcon');
        const sendBtn = document.getElementById('sendBtn');

        // Pause/resume on hover & typing (desktop Instagram-like)
        if (contentEl) {
            contentEl.addEventListener('mouseenter', pauseStory);
            contentEl.addEventListener('mouseleave', resumeStory);
        }
        if (inputEl) {
            inputEl.addEventListener('focus', pauseStory);
            inputEl.addEventListener('blur', resumeStory);
        }

        // Like button
        if (likeBtn && likeIcon) {
            likeBtn.addEventListener('click', function() {
                likeBtn.classList.toggle('liked');
                if (likeIcon.classList.contains('fa-regular')) {
                    likeIcon.classList.remove('fa-regular');
                    likeIcon.classList.add('fa-solid');
                } else {
                    likeIcon.classList.remove('fa-solid');
                    likeIcon.classList.add('fa-regular');
                }
            });
        }

        // Message send (front-end feature)
        if (sendBtn && inputEl) {
            sendBtn.addEventListener('click', function() {
                const message = inputEl.value.trim();
                if (!message) return;

                // TODO: Here you can send AJAX to backend later
                // Example: POST /story-message with fetch()

                inputEl.value = '';
                showToast('Message sent to @' + storyUser.username);
            });

            // Enter key to send
            inputEl.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    sendBtn.click();
                }
            });
        }

        // Keyboard navigation
        document.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowLeft') previousStory();
            if (e.key === 'ArrowRight') nextStory();
            if (e.key === 'Escape') closeStory();
        });
    });
</script>
</body>
</html>       